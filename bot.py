import asyncio
import json
import csv
from datetime import datetime
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import Message

# === Твой токен ===
API_TOKEN = "8294966587:AAEtJH2NKjEAu0ZTskhiJYSf1QOtQKSPEAA"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- Архетипы ---
ARCHETYPES = {
    "a": "Мудрец",
    "b": "Воин",
    "c": "Творец",
    "d": "Заботливый",
    "e": "Лидер",
    "f": "Искатель",
    "g": "Маг",
    "h": "Гедонист"
}

# --- Информация по архетипам ---
ARCH_INFO = {
    "a": ("Мудрец", "Мудрость, глубина, умение видеть суть.",
          "Застревание в анализе, отстранённость.",
          "Соединяй знание с действием.", "Я превращаю понимание в результат."),
    "b": ("Воин", "Решимость, сила, дисциплина.",
          "Жёсткость, вспыльчивость.",
          "Направляй силу в созидание.", "Моя сила служит добру."),
    "c": ("Творец", "Воображение, оригинальность, поток идей.",
          "Прокрастинация, перфекционизм.",
          "Делай по 1% в день и показывай черновики миру.", "Я смело воплощаю идеи."),
    "d": ("Заботливый", "Сострадание, надёжность, эмпатия.",
          "Самопожертвование, обида.",
          "Помни о себе.", "Моя забота питает и меня, и других."),
    "e": ("Лидер", "Харизма, организованность, влияние.",
          "Контроль, давление, перегруз.",
          "Учись вдохновлять, а не давить.", "Я веду, вдохновляя."),
    "f": ("Искатель", "Свобода, любопытство, гибкость.",
          "Беспокойство, вечный побег.",
          "Находи смысл внутри себя.", "Я нахожу свободу внутри пути."),
    "g": ("Маг", "Интуиция, трансформация, стратегичность.",
          "Иллюзии, манипуляция.",
          "Используй силу во благо.", "Моя энергия созидает реальность."),
    "h": ("Гедонист", "Радость, чувственность, эстетика.",
          "Зависимости, избегание сложности.",
          "Соедини удовольствие и развитие.", "Я наслаждаюсь жизнью осознанно.")
}

# --- 40 вопросов ---
questions = [
    "1. Что для вас важнее всего?\nA) Знания\nB) Победа\nC) Творчество\nD) Помощь другим\nE) Влияние\nF) Свобода\nG) Изменения\nH) Удовольствие",
    "2. Какое качество лучше всего вас описывает?\nA) Мудрость\nB) Сила\nC) Воображение\nD) Забота\nE) Лидерство\nF) Любопытство\nG) Интуиция\nH) Легкость",
    "3. В какой ситуации вы чувствуете себя сильнее?\nA) Когда делюсь знаниями\nB) Когда защищаю слабых\nC) Когда создаю что-то новое\nD) Когда поддерживаю близких\nE) Когда веду за собой\nF) Когда открываю новые горизонты\nG) Когда нахожу скрытый смысл\nH) Когда наслаждаюсь моментом",
    "4. Что мотивирует вас вставать по утрам?\nA) Возможность узнать новое\nB) Цель и вызов\nC) Возможность творить\nD) Забота о близких\nE) Ответственность и успех\nF) Возможность исследовать\nG) Осознание смысла\nH) Радость жизни",
    "5. Какую книгу или фильм вы бы выбрали?\nA) Документальный\nB) Военный боевик\nC) Фэнтези или артхаус\nD) Семейная драма\nE) Биография лидера\nF) Приключение или путешествие\nG) Мистика или философия\nH) Романтическая комедия",
    "6. Как вы реагируете на трудности?\nA) Анализирую и ищу выводы\nB) Борюсь до конца\nC) Ищу творческое решение\nD) Проявляю заботу\nE) Беру ответственность\nF) Ухожу и переосмысливаю\nG) Ищу глубинную причину\nH) Стараюсь отвлечься и получить удовольствие",
    "7. Какая деятельность приносит вам радость?\nA) Учиться и рассуждать\nB) Соревноваться и побеждать\nC) Рисовать, писать, создавать\nD) Помогать и поддерживать\nE) Руководить и достигать\nF) Путешествовать и открывать новое\nG) Медитировать и наблюдать\nH) Наслаждаться и вдохновляться",
    "8. С кем вам комфортнее всего?\nA) С умными людьми\nB) С сильными и решительными\nC) С творческими\nD) С добрыми и мягкими\nE) С целеустремленными\nF) С открытыми к новому\nG) С глубокими и загадочными\nH) С позитивными и лёгкими",
    "9. Что для вас главная ценность?\nA) Истина\nB) Справедливость\nC) Самовыражение\nD) Любовь\nE) Влияние\nF) Свобода\nG) Гармония\nH) Радость",
    "10. Какое слово ближе вам по духу?\nA) Знание\nB) Сила\nC) Идея\nD) Забота\nE) Успех\nF) Открытие\nG) Преображение\nH) Наслаждение",
    "11. Что для вас самое важное в отношениях?\nA) Понимание\nB) Надёжность\nC) Вдохновение\nD) Поддержка\nE) Уважение\nF) Свобода\nG) Энергия\nH) Эмоции",
    "12. Каким вы видите своё предназначение?\nA) Учить и просвещать\nB) Побеждать и защищать\nC) Творить и вдохновлять\nD) Помогать и заботиться\nE) Руководить и менять мир\nF) Искать и исследовать\nG) Преображать и исцелять\nH) Радоваться и делиться счастьем",
    "13. Что вас больше всего раздражает?\nA) Глупость\nB) Слабость\nC) Обыденность\nD) Безразличие\nE) Хаос\nF) Скука\nG) Ложь\nH) Ограничения",
    "14. Какая фраза ближе вам?\nA) «Знание — сила»\nB) «Через борьбу к звёздам»\nC) «Мир — это холст»\nD) «Счастье других — моё счастье»\nE) «Результат — всё»\nF) «Жизнь — это путь»\nG) «Мы творим свою реальность»\nH) «Живи красиво»",
    "15. Каким вы видите идеальный день?\nA) В тишине с книгой\nB) В действии и движении\nC) В творческом потоке\nD) В кругу близких\nE) На встречах и проектах\nF) В путешествии\nG) В медитации\nH) На уютной вечеринке",
    "16. Как вы относитесь к переменам?\nA) Анализирую\nB) Принимаю как вызов\nC) Творю новые формы\nD) Осторожно\nE) Использую во благо\nF) Приветствую\nG) Чувствую их заранее\nH) Наслаждаюсь ими",
    "17. Что вам нужно для счастья?\nA) Познание\nB) Победы\nC) Самовыражение\nD) Близкие люди\nE) Достижения\nF) Свобода\nG) Гармония\nH) Радость",
    "18. Как вы проявляете себя в команде?\nA) Даю советы\nB) Беру ответственность\nC) Генерирую идеи\nD) Поддерживаю других\nE) Руководю\nF) Исследую новое\nG) Вижу связи\nH) Поднимаю настроение",
    "19. Какая ваша сила?\nA) Мудрость\nB) Сила воли\nC) Креативность\nD) Эмпатия\nE) Организация\nF) Гибкость\nG) Интуиция\nH) Оптимизм",
    "20. Что помогает вам чувствовать смысл?\nA) Знание\nB) Цель\nC) Созидание\nD) Любовь\nE) Лидерство\nF) Путешествие\nG) Преображение\nH) Наслаждение",
    "21. Если бы вы выиграли миллион, куда бы потратили?\nA) На образование\nB) На развитие дела\nC) На творчество\nD) На помощь людям\nE) На инвестиции\nF) На путешествия\nG) На духовные практики\nH) На удовольствия",
    "22. Какая атмосфера вас вдохновляет?\nA) Спокойствие и книги\nB) Соревнование и энергия\nC) Искусство и креатив\nD) Тепло и уют\nE) Движение и цели\nF) Свежесть и свобода\nG) Мистика и свечи\nH) Музыка и смех",
    "23. Что для вас важнее в работе?\nA) Смысл\nB) Результат\nC) Возможность творить\nD) Польза другим\nE) Контроль\nF) Разнообразие\nG) Влияние\nH) Эстетика",
    "24. Какое чувство вам ближе?\nA) Интерес\nB) Гнев\nC) Вдохновение\nD) Сострадание\nE) Воля\nF) Азарт\nG) Озарение\nH) Восторг",
    "25. Как вы отдыхаете?\nA) Слушаю лекции\nB) Тренируюсь\nC) Рисую/пишу\nD) Провожу время с семьей\nE) Планирую будущее\nF) Путешествую\nG) Медитирую\nH) Смотрю фильмы",
    "26. Как вы относитесь к конфликтам?\nA) Анализирую обе стороны\nB) Иду в лоб\nC) Ищу компромисс\nD) Стараюсь смягчить\nE) Веду переговоры\nF) Отстраняюсь\nG) Преобразую ситуацию\nH) Улыбаюсь и отпускаю",
    "27. Что делает вас счастливым?\nA) Понимание мира\nB) Победы\nC) Самовыражение\nD) Любовь и близость\nE) Успех\nF) Приключения\nG) Глубина\nH) Красота",
    "28. Какое ваше главное правило?\nA) Познавай\nB) Борись\nC) Создавай\nD) Заботься\nE) Руководи\nF) Ищи\nG) Трансформируй\nH) Наслаждайся",
    "29. Как вы принимаете решения?\nA) Обдумываю\nB) Действую\nC) Чувствую\nD) Советуюсь\nE) Руководствуюсь логикой\nF) Следую интуиции\nG) Вижу знаки\nH) Делаю, как по душе",
    "30. Какая цитата ближе вам?\nA) «Знание — свет»\nB) «Сила в действии»\nC) «Жизнь — искусство»\nD) «Любовь спасёт мир»\nE) «Время — власть»\nF) «Жизнь — путь»\nG) «Мы создаём реальность»\nH) «Живи красиво»",
    "31. Что вы ищете в жизни?\nA) Истину\nB) Цель\nC) Самовыражение\nD) Гармонию\nE) Признание\nF) Свободу\nG) Энергию\nH) Радость",
    "32. Какая ваша суперсила?\nA) Мудрость\nB) Храбрость\nC) Креативность\nD) Забота\nE) Воля\nF) Гибкость\nG) Интуиция\nH) Энергия",
    "33. Что помогает вам двигаться вперёд?\nA) Любопытство\nB) Цель\nC) Вдохновение\nD) Люди рядом\nE) Ответственность\nF) Интерес к новому\nG) Вера в смысл\nH) Красота",
    "34. Что вы цените в других людях?\nA) Ум\nB) Силу\nC) Творчество\nD) Доброе сердце\nE) Уверенность\nF) Открытость\nG) Мудрость\nH) Позитивность",
    "35. Что бы вы хотели улучшить в себе?\nA) Терпение\nB) Самоконтроль\nC) Последовательность\nD) Умение говорить «нет»\nE) Организованность\nF) Умение отдыхать\nG) Спокойствие\nH) Умеренность",
    "36. Какое ваше отношение к риску?\nA) Обдумываю\nB) Принимаю вызов\nC) Творчески подхожу\nD) Избегаю\nE) Контролирую\nF) Иду, если интересно\nG) Доверяю судьбе\nH) Наслаждаюсь процессом",
    "37. Что делает вас уверенным?\nA) Знание\nB) Победа\nC) Удача\nD) Любовь\nE) Успех\nF) Опыт\nG) Интуиция\nH) Наслаждение",
    "38. Какая ситуация вас вдохновляет?\nA) Когда учусь\nB) Когда побеждаю\nC) Когда создаю\nD) Когда помогаю\nE) Когда веду\nF) Когда открываю новое\nG) Когда чувствую поток\nH) Когда наслаждаюсь моментом",
    "39. Что вы цените в жизни больше всего?\nA) Истину\nB) Цель\nC) Творчество\nD) Семью\nE) Достижения\nF) Свободу\nG) Гармонию\nH) Радость",
    "40. Каким бы вы хотели, чтобы вас запомнили?\nA) Мудрым\nB) Смелым\nC) Вдохновляющим\nD) Добрым\nE) Лидером\nF) Свободным\nG) Мистическим\nH) Счастливым"
] + [f"{i}. Вопрос {i}" for i in range(11, 41)]

# --- Память пользователей ---
user_progress = {}

# --- Команда /start ---
@dp.message(Command("start"))
async def start_test(message: Message):
    user_progress[message.from_user.id] = {"index": 0, "answers": []}
    await message.answer(
        "Привет 👋 Это тест на архетип личности.\nОтвечай одной буквой (A–H).\n\n" + QUESTIONS[0]
    )

# --- Обработка ответов ---
@dp.message()
async def handle_answer(message: Message):
    uid = message.from_user.id
    if uid not in user_progress:
        await message.answer("Чтобы начать тест, напиши /start 🙂")
        return

    ans = message.text.strip().lower()
    if ans not in ARCHETYPES.keys():
        await message.answer("Пожалуйста, отвечай одной буквой: A–H.")
        return

    user_progress[uid]["answers"].append(ans)
    user_progress[uid]["index"] += 1

    if user_progress[uid]["index"] < len(QUESTIONS):
        await message.answer(QUESTIONS[user_progress[uid]['index']])
    else:
        answers = user_progress[uid]["answers"]
        counts = {k: answers.count(k) for k in ARCHETYPES.keys()}
        sorted_a = sorted(counts.items(), key=lambda x: x[1], reverse=True)
        main_key = sorted_a[0][0]
        second_key = sorted_a[1][0] if len(sorted_a) > 1 else None

        main_info = ARCH_INFO[main_key]
        text = (
            f"✨ Твой архетип — {main_info[0]}\n"
            f"Сильные стороны: {main_info[1]}\n"
            f"Тени: {main_info[2]}\n"
            f"Совет: {main_info[3]}\n"
            f"Аффирмация: {main_info[4]}"
        )
        if second_key:
            text += f"\n\nВторостепенный архетип: {ARCHETYPES[second_key]}"

        await message.answer(text)
        user_progress.pop(uid, None)

async def main():
    print("Starting polling...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())

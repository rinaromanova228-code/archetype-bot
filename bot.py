import asyncio
import json
import csv
from datetime import datetime
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import Message

# === –¢–≤–æ–π —Ç–æ–∫–µ–Ω ===
API_TOKEN = "8294966587:AAEtJH2NKjEAu0ZTskhiJYSf1QOtQKSPEAA"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- –ê—Ä—Ö–µ—Ç–∏–ø—ã ---
ARCHETYPES = {
    "a": "–ú—É–¥—Ä–µ—Ü",
    "b": "–í–æ–∏–Ω",
    "c": "–¢–≤–æ—Ä–µ—Ü",
    "d": "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π",
    "e": "–õ–∏–¥–µ—Ä",
    "f": "–ò—Å–∫–∞—Ç–µ–ª—å",
    "g": "–ú–∞–≥",
    "h": "–ì–µ–¥–æ–Ω–∏—Å—Ç"
}

# --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–µ—Ç–∏–ø–∞–º ---
ARCH_INFO = {
    "a": ("–ú—É–¥—Ä–µ—Ü", "–ú—É–¥—Ä–æ—Å—Ç—å, –≥–ª—É–±–∏–Ω–∞, —É–º–µ–Ω–∏–µ –≤–∏–¥–µ—Ç—å —Å—É—Ç—å.",
          "–ó–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏–µ –≤ –∞–Ω–∞–ª–∏–∑–µ, –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ—Å—Ç—å.",
          "–°–æ–µ–¥–∏–Ω—è–π –∑–Ω–∞–Ω–∏–µ —Å –¥–µ–π—Å—Ç–≤–∏–µ–º.", "–Ø –ø—Ä–µ–≤—Ä–∞—â–∞—é –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç."),
    "b": ("–í–æ–∏–Ω", "–†–µ—à–∏–º–æ—Å—Ç—å, —Å–∏–ª–∞, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞.",
          "–ñ—ë—Å—Ç–∫–æ—Å—Ç—å, –≤—Å–ø—ã–ª—å—á–∏–≤–æ—Å—Ç—å.",
          "–ù–∞–ø—Ä–∞–≤–ª—è–π —Å–∏–ª—É –≤ —Å–æ–∑–∏–¥–∞–Ω–∏–µ.", "–ú–æ—è —Å–∏–ª–∞ —Å–ª—É–∂–∏—Ç –¥–æ–±—Ä—É."),
    "c": ("–¢–≤–æ—Ä–µ—Ü", "–í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –ø–æ—Ç–æ–∫ –∏–¥–µ–π.",
          "–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è, –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º.",
          "–î–µ–ª–∞–π –ø–æ 1% –≤ –¥–µ–Ω—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–π —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –º–∏—Ä—É.", "–Ø —Å–º–µ–ª–æ –≤–æ–ø–ª–æ—â–∞—é –∏–¥–µ–∏."),
    "d": ("–ó–∞–±–æ—Ç–ª–∏–≤—ã–π", "–°–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, —ç–º–ø–∞—Ç–∏—è.",
          "–°–∞–º–æ–ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ, –æ–±–∏–¥–∞.",
          "–ü–æ–º–Ω–∏ –æ —Å–µ–±–µ.", "–ú–æ—è –∑–∞–±–æ—Ç–∞ –ø–∏—Ç–∞–µ—Ç –∏ –º–µ–Ω—è, –∏ –¥—Ä—É–≥–∏—Ö."),
    "e": ("–õ–∏–¥–µ—Ä", "–•–∞—Ä–∏–∑–º–∞, –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, –≤–ª–∏—è–Ω–∏–µ.",
          "–ö–æ–Ω—Ç—Ä–æ–ª—å, –¥–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–≥—Ä—É–∑.",
          "–£—á–∏—Å—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å, –∞ –Ω–µ –¥–∞–≤–∏—Ç—å.", "–Ø –≤–µ–¥—É, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è."),
    "f": ("–ò—Å–∫–∞—Ç–µ–ª—å", "–°–≤–æ–±–æ–¥–∞, –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –≥–∏–±–∫–æ—Å—Ç—å.",
          "–ë–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, –≤–µ—á–Ω—ã–π –ø–æ–±–µ–≥.",
          "–ù–∞—Ö–æ–¥–∏ —Å–º—ã—Å–ª –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è.", "–Ø –Ω–∞—Ö–æ–∂—É —Å–≤–æ–±–æ–¥—É –≤–Ω—É—Ç—Ä–∏ –ø—É—Ç–∏."),
    "g": ("–ú–∞–≥", "–ò–Ω—Ç—É–∏—Ü–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–Ω–æ—Å—Ç—å.",
          "–ò–ª–ª—é–∑–∏–∏, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è.",
          "–ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–ª—É –≤–æ –±–ª–∞–≥–æ.", "–ú–æ—è —ç–Ω–µ—Ä–≥–∏—è —Å–æ–∑–∏–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å."),
    "h": ("–ì–µ–¥–æ–Ω–∏—Å—Ç", "–†–∞–¥–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —ç—Å—Ç–µ—Ç–∏–∫–∞.",
          "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∏–∑–±–µ–≥–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.",
          "–°–æ–µ–¥–∏–Ω–∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ.", "–Ø –Ω–∞—Å–ª–∞–∂–¥–∞—é—Å—å –∂–∏–∑–Ω—å—é –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.")
}

# --- 40 –≤–æ–ø—Ä–æ—Å–æ–≤ ---
QUESTIONS = [
    "1. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –≤ –∂–∏–∑–Ω–∏?\nA) –ó–Ω–∞–Ω–∏—è\nB) –ü–æ–±–µ–¥–∞\nC) –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ\nD) –ü–æ–º–æ—â—å –¥—Ä—É–≥–∏–º\nE) –í–ª–∏—è–Ω–∏–µ\nF) –°–≤–æ–±–æ–¥–∞\nG) –ò–∑–º–µ–Ω–µ–Ω–∏–µ\nH) –£–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ",
    "2. –ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ç—ã –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ü–µ–Ω–∏—à—å –≤ —Å–µ–±–µ?\nA) –ú—É–¥—Ä–æ—Å—Ç—å\nB) –°–∏–ª—É\nC) –í–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ\nD) –î–æ–±—Ä–æ—Ç—É\nE) –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å\nF) –õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ\nG) –ò–Ω—Ç—É–∏—Ü–∏—é\nH) –õ—ë–≥–∫–æ—Å—Ç—å",
    "3. –í –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ?\nA) –ö–æ–≥–¥–∞ –¥–µ–ª—é—Å—å –∑–Ω–∞–Ω–∏—è–º–∏\nB) –ö–æ–≥–¥–∞ –∑–∞—â–∏—â–∞—é —Å–ª–∞–±—ã—Ö\nC) –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—é —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ\nD) –ö–æ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é –±–ª–∏–∑–∫–∏—Ö\nE) –ö–æ–≥–¥–∞ –≤–µ–¥—É –∑–∞ —Å–æ–±–æ–π\nF) –ö–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞—é –Ω–æ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã\nG) –ö–æ–≥–¥–∞ –Ω–∞—Ö–æ–∂—É —Å–∫—Ä—ã—Ç—ã–π —Å–º—ã—Å–ª\nH) –ö–æ–≥–¥–∞ –Ω–∞—Å–ª–∞–∂–¥–∞—é—Å—å –º–æ–º–µ–Ω—Ç–æ–º",
    "4. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏?\nA) –ß—Ç–µ–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ\nB) –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è\nC) –ò—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ\nD) –ó–∞–±–æ—Ç–∞ –æ –¥—Ä—É–≥–∏—Ö\nE) –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ —Ü–µ–ª–∏\nF) –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\nG) –ú–µ–¥–∏—Ç–∞—Ü–∏–∏\nH) –†–∞–¥–æ—Å—Ç–∏",
    "5. –ß—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ —Ä–µ—à–∞—Ç—å —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏?\nA) –õ–æ–≥–∏–∫–∞\nB) –°–∏–ª–∞ –≤–æ–ª–∏\nC) –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å\nD) –°–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ\nE) –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å\nF) –û–ø—ã—Ç\nG) –ò–Ω—Ç—É–∏—Ü–∏—è\nH) –£–º–µ–Ω–∏–µ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è",
    "6. –ö–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å —Å–≤–æ—é –º–∏—Å—Å–∏—é –≤ –∂–∏–∑–Ω–∏?\nA) –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è\nB) –°—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞ –ø—Ä–∞–≤–¥—É\nC) –û—Å—Ç–∞–≤–∏—Ç—å —Å–ª–µ–¥ –≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ\nD) –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö\nE) –°–æ–∑–¥–∞–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É\nF) –ò—Å–∫–∞—Ç—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ\nG) –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –º–∏—Ä\nH) –ñ–∏—Ç—å –∫—Ä–∞—Å–∏–≤–æ",
    "7. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∏–º–≤–æ–ª —É—Å–ø–µ—Ö–∞?\nA) –ö–Ω–∏–≥–∞\nB) –ú–µ–¥–∞–ª—å\nC) –ö–∞—Ä—Ç–∏–Ω–∞\nD) –°—á–∞—Å—Ç–ª–∏–≤–∞—è —Å–µ–º—å—è\nE) –ö–æ–º–∞–Ω–¥–∞\nF) –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ\nG) –î—É—Ö–æ–≤–Ω—ã–π –æ–ø—ã—Ç\nH) –í–µ—á–µ—Ä–∏–Ω–∫–∞",
    "8. –ö–∞–∫ —Ç—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?\nA) –û–±–¥—É–º–∞–Ω–Ω–æ\nB) –†–µ—à–∏—Ç–µ–ª—å–Ω–æ\nC) –¢–≤–æ—Ä—á–µ—Å–∫–∏\nD) –ó–∞–±–æ—Ç–ª–∏–≤–æ\nE) –£–≤–µ—Ä–µ–Ω–Ω–æ\nF) –ò—Å—Å–ª–µ–¥—É—è\nG) –¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ\nH) –°–ø–æ–Ω—Ç–∞–Ω–Ω–æ",
    "9. –ö–∞–∫—É—é —Ä–æ–ª—å —á–∞—â–µ –≤—Å–µ–≥–æ –∑–∞–Ω–∏–º–∞–µ—à—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏?\nA) –°–æ–≤–µ—Ç—á–∏–∫\nB) –ó–∞—â–∏—Ç–Ω–∏–∫\nC) –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π\nD) –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π\nE) –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä\nF) –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç\nG) –ù–∞—Å—Ç–∞–≤–Ω–∏–∫\nH) –î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏",
    "10. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∏—Å—Ç–æ—á–Ω–∏–∫ —Ä–∞–¥–æ—Å—Ç–∏?\nA) –ü–æ–∑–Ω–∞–Ω–∏–µ\nB) –ü–æ–±–µ–¥—ã\nC) –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ\nD) –ë–ª–∏–∑–∫–∏–µ\nE) –í–ª–∏—è–Ω–∏–µ\nF) –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\nG) –û–∑–∞—Ä–µ–Ω–∏—è\nH) –ö—Ä–∞—Å–æ—Ç–∞ –∂–∏–∑–Ω–∏"
] + [f"{i}. –í–æ–ø—Ä–æ—Å {i}" for i in range(11, 41)]

# --- –ü–∞–º—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
user_progress = {}

# --- –ö–æ–º–∞–Ω–¥–∞ /start ---
@dp.message(Command("start"))
async def start_test(message: Message):
    user_progress[message.from_user.id] = {"index": 0, "answers": []}
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç üëã –≠—Ç–æ —Ç–µ—Å—Ç –Ω–∞ –∞—Ä—Ö–µ—Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏.\n–û—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ–π –±—É–∫–≤–æ–π (A‚ÄìH).\n\n" + QUESTIONS[0]
    )

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ ---
@dp.message()
async def handle_answer(message: Message):
    uid = message.from_user.id
    if uid not in user_progress:
        await message.answer("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç, –Ω–∞–ø–∏—à–∏ /start üôÇ")
        return

    ans = message.text.strip().lower()
    if ans not in ARCHETYPES.keys():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ–π –±—É–∫–≤–æ–π: A‚ÄìH.")
        return

    user_progress[uid]["answers"].append(ans)
    user_progress[uid]["index"] += 1

    if user_progress[uid]["index"] < len(QUESTIONS):
        await message.answer(QUESTIONS[user_progress[uid]['index']])
    else:
        answers = user_progress[uid]["answers"]
        counts = {k: answers.count(k) for k in ARCHETYPES.keys()}
        sorted_a = sorted(counts.items(), key=lambda x: x[1], reverse=True)
        main_key = sorted_a[0][0]
        second_key = sorted_a[1][0] if len(sorted_a) > 1 else None

        main_info = ARCH_INFO[main_key]
        text = (
            f"‚ú® –¢–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø ‚Äî {main_info[0]}\n"
            f"–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: {main_info[1]}\n"
            f"–¢–µ–Ω–∏: {main_info[2]}\n"
            f"–°–æ–≤–µ—Ç: {main_info[3]}\n"
            f"–ê—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—è: {main_info[4]}"
        )
        if second_key:
            text += f"\n\n–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –∞—Ä—Ö–µ—Ç–∏–ø: {ARCHETYPES[second_key]}"

        await message.answer(text)
        user_progress.pop(uid, None)

async def main():
    print("Starting polling...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
